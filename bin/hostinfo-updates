#!/bin/bash

VERBOSE=0
INIT_FILE='/etc/hostinforc'
if [[ -s $INIT_FILE ]]
then
	. $INIT_FILE
else
	echo "ERROR: Missing hostinfo initialization file: $INIT_FILE"
	echo
	exit 1
fi

case $1 in
-v) VERBOSE=1 ;;
esac

(( VERBOSE )) && echo "Getting third party packages"
COUNT_NVR=$(rpm -qa --queryformat "%{DISTRIBUTION}|%{NAME}\n" | egrep -iv "^SUSE:SLE-12:GA|^SUSE Linux Enterprise|gpg-pubkey$" | wc -l)
echo $COUNT_NVR > $FILE_NON_VENDOR_PACKAGES

(( VERBOSE )) && echo "Getting date of last installed package"
LIP_ALL=$(rpm -qa --last | head -1)
LIP_NAME=$(echo $LIP_ALL | cut -d' ' -f1)
LIP_DATE=$(echo $LIP_ALL | sed -e "s/${LIP_NAME}[[:space:]]*//g")
echo $LIP_DATE > $FILE_LAST_PACKAGE

(( VERBOSE )) && echo "Getting patches needed count"
PATCH_STRING=$(zypper --non-interactive --no-gpg-checks patch-check | tail -1 | grep -i patches 2>/dev/null)
if [[ -n "$PATCH_STRING" ]]
then
	PATCH_COUNT_NEEDED=$(echo $PATCH_STRING | cut -d' ' -f1)
	PATCH_COUNT_SECURITY=$(echo $PATCH_STRING | cut -d\( -f2 | cut -d' ' -f1)
	echo "${PATCH_COUNT_NEEDED}|${PATCH_COUNT_SECURITY}" > $FILE_PATCH_CHECK
else
	rm -f $FILE_PATCH_CHECK
	(( VERBOSE )) && echo " WARNING: Try again later"
fi

